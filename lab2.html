<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>б1-ИФСТипу-41 - Работа 2</title>
    <style>
        .scrollable::-webkit-scrollbar {
            width: 10px;
        }
        .scrollable::-webkit-scrollbar-track {
            background: rgb(166, 193, 166);
        }
        .scrollable::-webkit-scrollbar-thumb {
            background-color: green;
            border: 2px solid rgb(0, 75, 0);
        }
        body {
            padding: 0;
            margin: 0;
            background-color: #f4f4f9;
            font-family: 'Verdana', sans-serif;
            color: #333;
        }

        * {
            box-sizing: border-box;
            font-family: 'Arial';
        }

        p {
            margin: 0px;
        }

        sub{
            margin-top: 12px;
        }
        sup{
            margin-top: -12px;
        }
        .sub{
            margin-left: -7px;
        }

        form {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            padding-top: 3px;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"]:focus{
            outline: none;
            background-color: rgb(255, 255, 255);
        }

        .x0 {
            width: calc((99% - 760px));
        }
        .z{
            width: 360px;
        }
        .f {
            width: 400px;
        }

        h4 {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 30px;
            font-size: 20px;
        }

        .inputs {
            height: calc(100% - 40px);
            overflow-y: scroll;
        }

        .x0 input,
        .z input {
            border: 0;
            border-left: 1px solid black;
            text-align: center;
            height: 100%;
            background-color: rgb(208, 255, 162);
            font-size: 16px;
        }

        .input-block {
            width: 100%;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid black;
            padding: 1px;
            background-color: rgb(220, 255, 220);
            color: black
        }

        .input-block label {
            width: 80%;
            font-size: 16px;
            padding: 3px;
            font-weight: 500;
        }

        .input-block input {
            width: 20%;
            text-align: center;
        }

        .x0 .input-block label,
        .x0 header .p-title {
            width: 55%;
        }

        .x0 header .p,
        .x0 input {
            width: 15%;
        }

        header.input-block {
            height: 30px;
            overflow-y: scroll;
        }

        .x0 header p {
            text-align: center;
            font-size: 18px;
        }

        .z header .p-title {
            width: 100%;
        }

        .c header .p {
            width: 20%;
        }

        .z header p {
            text-align: center;
            font-size: 20px;
        }

        header {
            background-color: #4CAF50;
            color: white;
            display: flex;
            height: 40px;
        }

        .f header .p-title {
            width: 100%;
            text-align: center;
            font-size: 20px;
        }

        .function {
            display: flex;
            align-items: center;
            border-top: 1px solid black;
            width: 100%;
            padding: 3px;
            background-color: rgb(220, 255, 220);
        }

        .function-block {
            display: flex;
            justify-content: space-evenly;
            padding: 1px;
            margin: 0 2px;
        }

        .function label {
            display: flex;
            align-items: center;
            flex-direction: row;
            width: 30px;
            font-size: 14px;
        }

        .z .function label {
            width: 16px;
        }

        .f-title {
            width: 70px !important;
            height: 100%;
            font-size: 14px;
        }

        .function input {
            text-align: center;
            width: 50px;
            height: 30px;
            background-color: rgb(208, 255, 162);
            font-size: 16px;
            border: 1px solid black;
        }

        #result {
            display: none;
            background-color: rgba(0, 0, 0, 0.262);
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            align-items: center;
            justify-content: center;
        }

        .inner {
            width: 98vw;
            height: 98vh;
            background-color: white;
        }

        .inner-header {
            height: 30px;
            background-color: rgb(0, 45, 0);
            display: flex;
            justify-content: end;
        }

        #close {
            background-color: red;
            height: 30px;
            width: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 0;
            color: white;
            font-size: 20px;
        }

        .graph {
            height: calc(98vh - 30px);
            width: 98vw;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            overflow-y: scroll;
        }

        canvas {
            border: solid 1px black;
        }

        .inputs {
            display: flex;
            flex-direction: column;
        }

        .values {
            display: flex;
            height: 90vh;
            justify-content: space-between;
        }
        .values section {
            border: 2px solid green;
        }

        .manage {
            width: 100%;
            height: 6vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .count {
            background-color: #4CAF50;
            font-size: 1.5rem;
            color: white;
            border: none;
            cursor: pointer;
            width: 80%;
            height: 100%;
            margin-top: 10px;
            border: 3px solid #2f6931;
        }

        .save {
            background-color: #4CAF50;
            font-size: 1rem;
            color: white;
            border: none;
            cursor: pointer;
            width: 10%;
            height: 100%;
            margin-top: 10px;
            border: 3px solid #2f6931;
        }
        .load {
            background-color: #4CAF50;
            font-size: 1rem;
            color: white;
            border: none;
            cursor: pointer;
            width: 10%;
            height: 100%;
            margin-top: 10px;
            border: 3px solid #2f6931;
        }

        .count:hover, .save:hover,.load:hover {
            background-color: #45a049;
        }
        .inner-head{
            width: 100%;
            display: flex;
            margin-right: 10px;
        }
        .p-title, .p{
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .legend{
            padding:2px;
        }

        @media(max-width: 1124px){
            .values{
                flex-direction: column;
            }
            .x0,.z,.f{
                height: 33%;
                width: 100%;
            }
            .count {
                font-size: 1rem;
            }
            .load, .save{
                font-size: 0.75rem;
            }
        }
    </style>
</head>

<body>
    <form id="main">

        <div class="values">
            <section class="x0">

                <header>
                    <div class="inner-head">
                        <p class="p-title">Параметры</p>
                        <p class="p">Нач. знач.</p>
                        <p class="p">Гран. знач.</p>
                        <p class="p">Норм. знамен.</p>
                    </div>
                </header>

                <div class="inputs scrollable">
                </div>
            </section>

            <section class="f">
                <header>
                    <div class="inner-head">
                        <p class="p-title">Полиномы</p>
                    </div>
                </header>

                <div class="inputs scrollable">
                </div>
            </section>

            <section class="z">
                <header>
                    <div class="inner-head">
                        <p class="p-title">Возмущения</p>
                    </div>
                </header>

                <div class="inputs scrollable">
                </div>
            </section>
        </div>

        <section class="manage">
            <button class="count" type="submit">Рассчитать</button>
            <button class="save" type="button" onclick="save()">Сохранить</button>
            <button class="load" type="button" onclick="load()">Загрузить</button>
        </section>

    </form>

    <section id="result">
        <div class="inner">
            <header class="inner-header">
                <button type="button" id="close">X</button>
            </header>
            <div class="graph scrollable">
                <canvas id="plot"></canvas>
                <canvas id="radar1"></canvas>
                <canvas id="radar2"></canvas>
                <canvas id="radar3"></canvas>
                <canvas id="radar4"></canvas>
                <canvas id="radar5"></canvas>
                <canvas id="radar6"></canvas>
                <div class="legend">
                </div>
            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Параметры
        const params = {
            "1": "эффективность функционирования хранилища данных",
            "2": "качество программного обеспечения",
            "3": "корректность программного обеспечения",
            "4": "надежность программного обеспечения",
            "5": "доступность программного обеспечения",
            "6": "возможность интенсивного использования программного обеспечения",
            "7": "прослеживаемость программного обеспечения",
            "8": "функциональная полнота программного обеспечения",
            "9": "обеспечение требуемой последовательности работ при проектировании хранилища",
            "10": "практичность программного обеспечения",
            "11": "устойчивость к ошибкам данных программного обеспечения",
            "12": "эффективность выполнения транзакций",
            "13": "степень мотивации персонала",
            "14": "удобство тестирования программного обеспечения",
        }

        const paramsDiv = document.querySelector("#main .values .x0 .inputs")
        const legendDiv = document.querySelector(".graph .legend")

        for(let key in params){
            paramsDiv.innerHTML +=
            `<div class="input-block">
                <label for="X${key}">[X<sub>${key}</sub>] - ${params[key]}</label>
                <input id="X${key}" type="number" step="0.001" min="0" max="1" required value="0.5">
                <input id="X${key}max" type="number" step="0.001" min="0" max="1" required value="1">
                <input id="X${key}norm" type="number" step="0.001" min="0" required value="1">
            </div>`;

            legendDiv.innerHTML +=
            `<p>[X<sub>${key}</sub>] - ${params[key]}</p>`;
        }

        // Полиномы
        const funcs = {
            "1":"1",
            "2":"2",
            "3":"3",
            "4":"4",
            "5":"5",
            "6":"6",
            "7":"7",
            "8":"8",
            "9":"9",
            "10":"10",
            "11":"11",
            "12":"12",
            "13":"13",
            "14":"14",
            "15":"1",
            "16":"2",
            "17":"3",
            "18":"4",
            "19":"5",
            "20":"6",
            "21":"7",
            "22":"8",
            "23":"9",
            "24":"10",
            "25":"11",
            "26":"12",
            "27":"13",
            "28":"14",
            "29":"1",
            "30":"2",
            "31":"3",
            "32":"4",
            "33":"5",
            "34":"6",
            "35":"7",
            "36":"8",
            "37":"9",
            "38":"10",
            "39":"11",
            "40":"12",
            "41":"13",
            "42":"14",
            "43":"1",
            "44":"2",
            "45":"3",
            "46":"4",
            "47":"5",
            "48":"6",
            "49":"7",
            "50":"8",
            "51":"9",
            "52":"10",
            "53":"11",
            "54":"12",
            "55":"13",
            "56":"14",
            "57":"4",
            "58":"6",
            "59":"9",
            "60":"10",
            "61":"13",
            "62":"1",
            "63":"2",
            "64":"3",
            "65":"4",
            "66":"5",
            "67":"6",
            "68":"7",
            "69":"8",
            "70":"9",
            "71":"10",
            "72":"11",
            "73":"12",
            "74":"13",
            "75":"14",
            "76":"1",
            "77":"2",
            "78":"3",
            "79":"4",
            "80":"6",
            "81":"9",
            "82":"10",
            "83":"1",
            "84":"2",
            "85":"3",
            "86":"4",
            "87":"5",
            "88":"6",
            "89":"7",
            "90":"10",
            "91":"11",
            "92":"12",
            "93":"13",
            "94":"14",
            "95":"1",
            "96":"2",
            "97":"3",
            "98":"4",
            "99":"5",
            "100":"6",
            "101":"7",
            "102":"8",
            "103":"9",
            "104":"10",
            "105":"11",
            "106":"12",
            "107":"13",
            "108":"14",
            "109":"1",
            "110":"2",
            "111":"3",
            "112":"4",
            "113":"8",
            "114":"10",
            "115":"12",
            "116":"13",
            "117":"14",
            "118":"5",
            "119":"6",
            "120":"1",
            "121":"2",
            "122":"3",
            "123":"4",
            "124":"5",
            "125":"6",
            "126":"7",
            "127":"8",
            "128":"9",
            "129":"10",
            "130":"11",
            "131":"13",
            "132":"14",
            "133":"1",
            "134":"2",
            "135":"3",
            "136":"4",
            "137":"5",
            "138":"6",
            "139":"7",
            "140":"8",
            "141":"10",
            "142":"11",
            "143":"12",
            "144":"13",
            "145":"14",
            "146":"9",
            "147":"5",
            "148":"7",
            "149":"11",
            "150":"13",
            "151":"2",
            "152":"4",
            "153":"14",
        }

        const funcsDiv = document.querySelector("#main .values .f .inputs")

        for(let key in funcs){
            funcsDiv.innerHTML +=
            `<div class="function">
                <label class="f-title" for="F${key}-d">F<sub>${key}</sub>(X<sub>${funcs[key]}</sub>)=</label>
                <div class="function-block">
                    <input id="F${key}-a" type="number" step="0.001" required value="0">
                    <label for="F${key}-a">X<sup>3</sup><sub class="sub">${funcs[key]}</sub>+</label>
                </div>
                <div class="function-block">
                    <input id="F${key}-b" type="number" step="0.001" required value="0">
                    <label for="F${key}-b">X<sup>2</sup><sub class="sub">${funcs[key]}</sub>+</label>
                </div>
                <div class="function-block">
                    <input id="F${key}-c" type="number" step="0.001" required value="1">
                    <label for="F${key}-c">X<sub>${funcs[key]}</sub>+</label>
                </div>
                <div class="function-block">
                    <input id="F${key}-d" type="number" step="0.001" required value="0">
                </div>
            </div>`;
        }

        // Возмущения
        const zfuncs = ["1","2","3","4","5"];

        const zfuncsDiv = document.querySelector("#main .values .z .inputs")

        for(let key in zfuncs){
            zfuncsDiv.innerHTML +=
            `<div class="function">
                <label class="f-title" for="Z${zfuncs[key]}-d">ξ<sub>${zfuncs[key]}</sub>(t)=</label>
                <div class="function-block">
                    <input id="Z${zfuncs[key]}-a" type="number" step="0.001" required value="0">
                    <label for="Z${zfuncs[key]}-a">t<sup>3</sup>+</label>
                </div>
                <div class="function-block">
                    <input id="Z${zfuncs[key]}-b" type="number" step="0.001" required value="0">
                    <label for="Z${zfuncs[key]}-b">t<sup>2</sup>+</label>
                </div>
                <div class="function-block">
                    <input id="Z${zfuncs[key]}-c" type="number" step="0.001" required value="1">
                    <label for="Z${zfuncs[key]}-c">t+</label>
                </div>
                <div class="function-block">
                    <input id="Z${zfuncs[key]}-d" type="number" step="0.001" required value="0">
                </div>
            </div>`;
        }
    </script>
    <script>
        const getData = () => {
            const form = document.querySelector("#main");

            //шаблон JSON-оъекта
            let data = {
                'x0': {},
                'f': {},
                'c': {},
                'max' : [],
            };

            //из каждого '.x0 .input-block' элемента, состоящего из 2-х input с данными о начальных значениях и границах нормы, извлекаем значения
            let x0s = form.querySelectorAll(".x0 .input-block");
            for (let i = 0; i < x0s.length; i++) {
                let key = `X${(i + 1)}`;
                data['x0'][key] = Number(x0s[i].querySelector(`#${key}`).value);
                data['c']['norm' + key] = Number(x0s[i].querySelector(`#${key}norm`).value);
                data['max'].push(Number(x0s[i].querySelector(`#${key}max`).value));
            }

            //из каждого '.z .function' элемента, состоящего из 4-х input с коэффициентами ввозмущений, извлекаем значения
            let zs = form.querySelectorAll(".z .function");
            for (let i = 0; i < zs.length; i++) {

                let valueA = zs[i].querySelector(`#Z${i + 1}-a`).value;
                let valueB = zs[i].querySelector(`#Z${i + 1}-b`).value;
                let valueC = zs[i].querySelector(`#Z${i + 1}-c`).value;
                let valueD = zs[i].querySelector(`#Z${i + 1}-d`).value;

                data['f'][`Z${i + 1}`] = {
                    a: Number(valueA),
                    b: Number(valueB),
                    c: Number(valueC),
                    d: Number(valueD)
                };
            }

            //из каждого '.f .function' элемента, состоящего из 4-х input с коэффициентами полиномов, извлекаем значения
            let fs = form.querySelectorAll(".f .function");
            fs.forEach(elem => {
                let frr = elem.querySelector("label").getAttribute("for")
                let key = frr.substring(0, frr.length-2);

                let valueA = elem.querySelector(`#${key}-a`).value;
                let valueB = elem.querySelector(`#${key}-b`).value;
                let valueC = elem.querySelector(`#${key}-c`).value;
                let valueD = elem.querySelector(`#${key}-d`).value;

                data['f'][`${key}`] = {
                    a: Number(valueA),
                    b: Number(valueB),
                    c: Number(valueC),
                    d: Number(valueD)
                };
            });

            return data;
        }

        const save = () => {
            let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(getData()));
            let dlAnchorElem = document.createElement("a");
            dlAnchorElem.setAttribute("href",     dataStr     );
            dlAnchorElem.setAttribute("download", "IPST2-2024.json");
            dlAnchorElem.click();
        }

        const load = () => {
            const getFileElement = document.createElement("input");
            getFileElement.setAttribute("type", "file");
            getFileElement.click();
            getFileElement.onchange = (event) => {
                return new Promise((resolve, reject) => {
                    const fileReader = new FileReader()
                    fileReader.onload = (e) => {
                        let obj = e.target.result;
                        try{
                            resolve(JSON.parse(obj));
                        }
                        catch {
                            alert("Неверный формат файла");
                        }
                    }
                    fileReader.readAsText(event.target.files[0]);
                }).then(data => {

                    let x0s = form.querySelectorAll(".x0 .input-block");
                    for (let i = 0; i < x0s.length; i++) {
                        let key = `X${(i + 1)}`;
                        x0s[i].querySelector(`#${key}`).value = data['x0'][key];
                        x0s[i].querySelector(`#${key}norm`).value = data['c']['norm' + key];
                        x0s[i].querySelector(`#${key}max`).value = data['max'][i];
                    }

                    let fs = form.querySelectorAll(".f .function");
                    fs.forEach(elem => {
                        let frr = elem.querySelector("label").getAttribute("for")
                        let key = frr.substring(0, frr.length-2);

                        elem.querySelector(`#${key}-a`).value = data['f'][`${key}`].a;
                        elem.querySelector(`#${key}-b`).value = data['f'][`${key}`].b;
                        elem.querySelector(`#${key}-c`).value = data['f'][`${key}`].c;
                        elem.querySelector(`#${key}-d`).value = data['f'][`${key}`].d;
                    });

                    let zs = form.querySelectorAll(".z .function");
                    zs.forEach(elem => {
                        let frr = elem.querySelector("label").getAttribute("for")
                        let key = frr.substring(0, frr.length-2);

                        elem.querySelector(`#${key}-a`).value = data['f'][`${key}`].a;
                        elem.querySelector(`#${key}-b`).value = data['f'][`${key}`].b;
                        elem.querySelector(`#${key}-c`).value = data['f'][`${key}`].c;
                        elem.querySelector(`#${key}-d`).value = data['f'][`${key}`].d;
                    });
                }).catch((err => {
                    alert(err);
                }))
            }
        }
    </script>
    <script>

        //Инициализация холстов для отрисовки графика и лепестковых диаграмм с применением Chart.js
        const plot = document.getElementById('plot');
        const radar1 = document.getElementById('radar1');
        const radar2 = document.getElementById('radar2');
        const radar3 = document.getElementById('radar3');
        const radar4 = document.getElementById('radar4');
        const radar5 = document.getElementById('radar5');
        const radar6 = document.getElementById('radar6');

        //основные элементы страницы
        const form = document.querySelector("#main");
        const resWin = document.getElementById('result');
        const resultDown = document.getElementById('close');

        //объект доступа к холстам с графиками и диаграммами
        let chartObjects = {
            'plot': null,
            't = 0': null,
            't = 0.2': null,
            't = 0.4': null,
            't = 0.6': null,
            't = 0.8': null,
            't = 1': null,
        }

        //при отправке формы - формируем JSON-объект, требуемый для POST-запроса на вычиления
        form.onsubmit = (e) => {
            e.preventDefault();

            let localData = getData();

            //выполняем запрос при помощи FETCH
            fetch('/api/lab2/count', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json;charset=utf-8'
                },
                body: JSON.stringify(localData)
            })
                .then(res => res.json())
                .then(res => {
                    // на основе полученного ответа отриосвываем графики, на ранее заданных холстах:
                    let sol = res['message'];
                    creatrGraph(sol);
                    createRadar('t = 0', radar1, sol[0], localData.max);
                    createRadar('t = 0.2', radar2, sol[4], localData.max);
                    createRadar('t = 0.4', radar3, sol[8], localData.max);
                    createRadar('t = 0.5', radar4, sol[12], localData.max);
                    createRadar('t = 0.8', radar5, sol[16], localData.max);
                    createRadar('t = 1', radar6, sol[20], localData.max);
                })
                .then(
                    res => {
                        resWin.style.display = "flex"
                    }
                )
                .catch(e => alert("Решение не найдено!"));
                ;
        }

        //скрыть окно результатов при закрытии
        resultDown.onclick = () => {
            resWin.style.display = "none";
        }

        //отрисовка графиков изменения параметров xi(t) на основе объекта решений solution
        const creatrGraph = (solution) => {

            //удаляем старый график
            chartObjects['plot']?.destroy();

            //готовим шаблон для построения графика
            let data = {
                labels: [0, 0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95, 1],
                datasets: [],
            }

            //заполняем массив datasets из шаблона
            for (let i = 0; i < solution[0].length; i++) {

                // получаем ряд значений для каждого параметра xi(t)
                let values = [];
                for (let j = 0; j < solution.length; j++) {
                    values.push(solution[j][i]);
                }

                //формируем график очередного параметра xi(t)
                let dataset = {
                    label: 'X' + (i + 1),
                    data: values,
                    fill: false,
                    borderColor: getColor(i),
                    tension: 0.1,
                    pointRadius: 0,
                    borderDash: getLineStyle(i),
                }
                data.datasets.push(dataset);
            }

            // Отрисовываем график
            chartObjects['plot'] = new Chart(plot, {
                type: 'line',
                data: data,
                options: {
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right',
                         }
                    },
                }
            });
        }

        //отрисовка лепестковых диаграмм для заданного временного среза на основе:
        // имени диаграммы chartName в объекте chartObjects
        // элемента холста plot
        // значений на срезе solutionI
        // границах нормы max
        const createRadar = (chartName, plot, solutionI, max) => {

            //удаляем старую диаграмму
            chartObjects[chartName]?.destroy();

            //готовим шаблон для построения диаграммы
            let data = {
                labels: ['X1', 'X2', 'X3', 'X4', 'X5', 'X6', 'X7', 'X8', 'X9', 'X10', 'X11', 'X12', 'X13', 'X14'],
                datasets: [
                    {
                        label: 'Значения параметров',
                        data: solutionI,
                        fill: false,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgb(54, 162, 235)',
                    },
                    {
                        label: 'Границы нормы',
                        data: max,
                        fill: true,
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderColor: 'rgb(255, 99, 132)',
                    },
                ],
            }

            // Отрисовываем диаграмму
            chartObjects[chartName] = new Chart(plot, {
                type: 'radar',
                data: data,
                options: {
                    plugins: {
                        title: {
                            display: true,
                            text: 'Срез значений при ' + chartName,
                            font: {
                                size: 14
                            }
                        }
                    }
                }
            });
        }

        // Стилизация графиков
        function getRandomColor() {
            let letters = '0123456789ABCDEF';
            let color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        const colors = ["red","orange","rgb(213, 216, 0)","rgb(7, 203, 0)","green","rgb(0, 207, 166)","blue","violet","purple","black","brown","gray"];

        function getColor(i) {
            return colors[i%colors.length];
        }
        function getLineStyle(i) {
            if (i <= colors.length - 1) return [];
            if (i <= 2*colors.length - 1) return [5, 2];
            if (i <= 3*colors.length - 1) return [20, 5, 20, 5];
        }

    </script>
</body>

</html>